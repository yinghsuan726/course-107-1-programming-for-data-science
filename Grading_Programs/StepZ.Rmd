---
title: "學生考卷網頁製作"
author: "林茂廷"
date: "11/17/2018"
output: html_document
params:
  baseDir: "/Users/martin/Desktop/GitHub/course-107-1-programming-for-data-science"
  examChunkSheetDir: "Midterm/ans"
  examEmptyRmd: "midterm.Rmd"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
load("StepZ_funs.Rda")
```

## chunkSheet資料引入

```{r}
workingPath<- file.path(params$baseDir,params$examChunkSheetDir)
tempPath <- file.path(workingPath,"temp")
if(!is.null(dir.exists(tempPath))) {
  dir.create(tempPath)
}
# locate chunksheet.rda
library(magrittr)
library(dplyr)
library(stringr)
list.files(workingPath) %T>%  
    {assign("workingPathListFiles",.,envir=globalenv())} %>%
  toupper %>%
  str_detect("CHUNKSHEET.RDA") %>%
  workingPathListFiles[.] -> chunkSheetName
chunkSheetFilePath <- file.path(workingPath,chunkSheetName)
load(chunkSheetFilePath)
```

## 產生學生考卷網頁

### 試題卷

```{r}
# 試題卷位置在working path上一層
workingPath %>%
  str_split("/") %>%
  unlist %>%
  {.[1:(length(.)-1)]} %>%
  paste0(.,collapse = "/") ->
  workingPathUpper

# 查出試卷file path
file.path(workingPathUpper,params$examEmptyRmd)->examEmptyFilePath

# 
readLines(examEmptyFilePath)->examEmptyLines
```

#### 更新setup chunk 

```{r}
examEmptyLines %>% chunkticksDF -> chunkTicks

setupChunkNameContent<-"```{r setup, include=TRUE, echo=FALSE}"

examEmptyLines[chunkTicks$start[1]]<- setupChunkNameContent

# update setup chunk
## newContent to add
newContent <-
  c("knitr::opts_chunk$set(echo = TRUE,message=FALSE,error=FALSE,eval=FALSE)",
    "library(klippy)",
    "klippy()")

## add newContent
examEmptyLines %>%
  chunkcontent_replace("setup",newContent,chunkTicks) ->
  examEmptyLines2
```

#### 試題卷ansXX部份插入`#ansXX#`

```{r}
chunkTicks$chunkName %>% #View
  str_subset("(ans[[:alnum:]]+)") -> allAnsChunkNames
library(purrr)
for(chunkName_i in allAnsChunkNames){
  #chunkName_i <- allAnsChunkNames[1]
  examEmptyLines2 %>% #update chunkTicks dataframe
    chunkticksDF -> chunkTicks
  newContent<-paste0("'",chunkName_i,"'") #create html replacement flag
  examEmptyLines2 %>% # insert flag
    chunkcontent_replace(
      chunkName_i,newContent,chunkTicks) -> 
    examEmptyLines2
}
examEmptyFilePath %>%
  basename %>%
  file.path(tempPath,.) -> examEmptyFilePath2
{writeLines(examEmptyLines2,examEmptyFilePath2)}
```

#### 轉出html

```{r}
rmarkdown::render(
  examEmptyFilePath2,
  output_format = "html_document",
  examEmptyFilePath2 %>% str_replace("(\\.Rmd)","\\.html"),
  quiet = T
)
```


### 答案卷

#### 取出答案chunk sheet

```{r}
names(chunkSheet) -> sheetNames
is.ans=T

sheetNames %>% str_detect("(-ANS)") %>% 
  sheetNames[.]->
  ansSheet

ansSheet %>% 
  function(sheetName_i,examEmptyFilePath=examEmptyFilePath,
           )

sheetName_i <- ansSheet
chunkSheet[[sheetName_i]]->targetSheet
```

#### 在空白考試卷插入答案code chunk
不直接用學生答案卷是為了避免學生亂搞原考卷檔。

```{r}

readLines(examEmptyFilePath)->examEmptyLines

examEmptyLines %>% chunkticksDF -> chunkTicks

examEmptyLines[chunkTicks$start[1]]<- setupChunkNameContent

# update setup chunk
## newContent to add
newContent <-
  c("knitr::opts_chunk$set(echo = TRUE,message=FALSE,error=FALSE,eval=FALSE)",
    "library(klippy)",
    "klippy()")

## add newContent
examEmptyLines %>%
  chunkcontent_replace("setup",newContent,chunkTicks) ->
  examEmptyLines2

chunkTicks$chunkName %>% #View
  str_subset("(ans[[:alnum:]]+)") -> allAnsChunkNames

chunkTicks %>%
  filter(chunkName %in% allAnsChunkNames) -> ansChunkTicks

## 以ans chunk name 新增class.source css name
for(i in 1:nrow(ansChunkTicks)){
  examEmptyLines2[ansChunkTicks$start[i]] %>%
    str_replace("\\}",
                paste0(', class.source="',
                       ifelse(is.ans==T,
                              "correctAns",
                       ansChunkTicks$chunkName[i]),
                       '"\\}')
                ) -> examEmptyLines2[ansChunkTicks$start[i]]
}
```

```{r}
## 填入chunk內容
library(purrr)
for(chunkName_i in allAnsChunkNames){
  #chunkName_i <- allAnsChunkNames[1]
  examEmptyLines2 %>% #update chunkTicks dataframe
    chunkticksDF -> chunkTicks
  
  newContent<-targetSheet$ansChunks[[chunkName_i]][-1] 
  
  examEmptyLines2 %>% # insert newContent
    chunkcontent_replace(
      chunkName_i,newContent,chunkTicks) -> 
    examEmptyLines2
}
```

```{r}
if(is.ans==T){
## 複製chunk 內容一次
examEmptyLines2 %>% chunkticksDF -> chunkTicks

chunkTicks$chunkName %>% #View
  str_subset("(ans[[:alnum:]]+)") -> allAnsChunkNames

# 資料做 chunk cut
ansChunkTicks <-
  chunkTicks %>% filter(chunkName %in% allAnsChunkNames)
allLinesNumberSeq <- 1:length(examEmptyLines2)

# 算cutpoints
ansChunkTicks$startCut<-ansChunkTicks$start-1
ansChunkTicks$endCut<-ansChunkTicks$end
rbind(ansChunkTicks$startCut,ansChunkTicks$endCut) %>% 
  c %>%
  {c(0,.,length(examEmptyLines2)+1)} -> cutPoints

# cut

allLinesNumberSeq %>% cut(cutPoints) -> LineChunkCat
levels(LineChunkCat) %>%
  {which((. %in% 
          paste0("(",ansChunkTicks$startCut,",",ansChunkTicks$endCut,"]")))}-> levelsName
levels(LineChunkCat)[levelsName]<-ansChunkTicks$chunkName

map(levels(LineChunkCat),function(x){
  #x<-levels(LineChunkCat)[2]
   chunkContent <- examEmptyLines2[which(LineChunkCat==x)]
    if(x %in% allAnsChunkNames){
       chunkL<-length(chunkContent)
       chunkMiddle <- chunkContent[2:(chunkL-1)]
       chunkNamePattern <- paste0("(",x,")")
       chunkContent<-c(
         paste0("```{r ",x,"}"),
         "```",
         paste0('<button data-toggle="collapse" data-target="#',x,'">參考答案...</button>'),
         paste0('<div id="',x,'" class="collapse">'),
         chunkContent %>% str_replace(chunkNamePattern,""),
         "</div>")
    }
   return(chunkContent)
   }
   ) %>% unlist ->
  examEmptyLines3  
}

```


### 儲存答案檔Rmd
```{r}
studentFilePath<-file.path(tempPath,paste0(sheetName_i,".Rmd"))
writeLines(examEmptyLines3,studentFilePath)

#### 轉成html template(set eval=F)
rmarkdown::render(
  studentFilePath,
  output_format = "html_document",
  studentFilePath %>% str_replace("(\\.Rmd)","\\.html"),
  quiet=TRUE
)
```

#### 學生html template取出答案elements存入chunksheet

```{r}
studentFilePath %>% str_replace("(\\.Rmd)","\\.html")->
  studentHTMLFilePath
readLines(studentHTMLFilePath) -> stuHTMLLines
```



### 答案卷

#### 轉成html template(set eval=F)

#### 答案卷html template取出答案elements存入chunksheet

### 每個學生產生一個html網頁

#### chunksheets取出該學生及答案html elemenets

## all functions

```{r}
chunkticksDF<-function(allLines){
  allLines %>%
  str_which("(```)") -> chunkTicksLoc
chunkTicks <-
  data.frame(
    start=chunkTicksLoc[seq(1,length(chunkTicksLoc),by=2)],
    end=chunkTicksLoc[seq(2,length(chunkTicksLoc),by=2)]
  )
chunkTicks %>%
  mutate(
    chunkName={ 
      chunkname_extract(allLines,chunkTicks)
      }
  ) -> chunkTicks
return(chunkTicks)
}

chunkname_extract<-function(allLines,chunkTicks){
  allLines[chunkTicks$start] %>%
    # r\\s or r preceeding [[:alnum:]]+ which is followed by \\} or ,
    str_extract("(?<=(r\\s|r))[[:alnum:]]+(?=(\\}|,))") ->
    chunkNames
  return(chunkNames)
}
chunkcontent_replace<-function(textLines,chunkname,newContent,chunkTicks){
chunkTicks %>%
    filter(chunkName==chunkname) -> setupChunk
  if(is.ans=F){
    
  }
    preText<-textLines[1:setupChunk$start]
    postText<-textLines[setupChunk$end:length(textLines)]
    c(
      preText,
      newContent,
      postText
    ) -> textLines  
  return(textLines)
}
StepZ_env=new.env()
# 找出所有function class object names
Filter(function(x) inherits(get(x), "function"), ls()) -> functionList
save(list=functionList,file="StepZ_funs.Rda")
```

